{% extends "base.html" %}

{% block title %}Event Calendar - SMVEC Events{% endblock %}

{% block extra_head %}
<style>
.calendar-container {
    max-width: 100%;
    margin: 0 auto;
}

.calendar-event {
    background-color: #007bff;
    color: white;
    padding: 2px 5px;
    border-radius: 3px;
    font-size: 0.8em;
    margin-bottom: 2px;
    cursor: pointer;
}

.calendar-event:hover {
    background-color: #0056b3;
}

.calendar-day {
    min-height: 100px;
    border: 1px solid #dee2e6;
    padding: 5px;
}

.calendar-day.other-month {
    background-color: #f8f9fa;
    color: #6c757d;
}

.calendar-day.today {
    background-color: #fff3cd;
}
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row">
        <div class="col-12">
            <h2><i class="fas fa-calendar"></i> Event Calendar</h2>
            <p class="lead">View all campus events in calendar format</p>
        </div>
    </div>

    <!-- Calendar Navigation -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="btn-group" role="group">
                <button type="button" class="btn btn-outline-primary" onclick="previousMonth()">
                    <i class="fas fa-chevron-left"></i> Previous
                </button>
                <button type="button" class="btn btn-outline-primary" onclick="today()">
                    Today
                </button>
                <button type="button" class="btn btn-outline-primary" onclick="nextMonth()">
                    Next <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        </div>
        <div class="col-md-6 text-md-end">
            <h4 id="current-month"></h4>
        </div>
    </div>

    <!-- Calendar Grid -->
    <div class="calendar-container">
        <div class="card">
            <div class="card-body p-0">
                <table class="table table-bordered mb-0">
                    <thead class="table-primary">
                        <tr>
                            <th class="text-center">Sunday</th>
                            <th class="text-center">Monday</th>
                            <th class="text-center">Tuesday</th>
                            <th class="text-center">Wednesday</th>
                            <th class="text-center">Thursday</th>
                            <th class="text-center">Friday</th>
                            <th class="text-center">Saturday</th>
                        </tr>
                    </thead>
                    <tbody id="calendar-body">
                        <!-- Calendar days will be generated by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Event Details Modal -->
    <div class="modal fade" id="eventModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="eventModalTitle">Event Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="eventModalBody">
                    <!-- Event details will be loaded here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <a href="#" id="eventDetailsLink" class="btn btn-primary">View Full Details</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Legend -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <h6>Legend:</h6>
                    <div class="row">
                        <div class="col-md-3">
                            <span class="calendar-event d-inline-block">Technical Events</span>
                        </div>
                        <div class="col-md-3">
                            <span class="calendar-event d-inline-block" style="background-color: #28a745;">Cultural Events</span>
                        </div>
                        <div class="col-md-3">
                            <span class="calendar-event d-inline-block" style="background-color: #ffc107; color: black;">Sports Events</span>
                        </div>
                        <div class="col-md-3">
                            <span class="calendar-event d-inline-block" style="background-color: #dc3545;">Academic Events</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
// Event data from backend
const events = {{ events | tojson | safe }};

// Current calendar state
let currentDate = new Date();
let currentMonth = currentDate.getMonth();
let currentYear = currentDate.getFullYear();

// Category colors
const categoryColors = {
    'Technical': '#007bff',
    'Cultural': '#28a745',
    'Sports': '#ffc107',
    'Academic': '#dc3545',
    'Workshop': '#17a2b8',
    'Seminar': '#6610f2',
    'Other': '#6c757d'
};

function initCalendar() {
    updateCalendarHeader();
    generateCalendar();
}

function updateCalendarHeader() {
    const monthNames = [
        'January', 'February', 'March', 'April', 'May', 'June',
        'July', 'August', 'September', 'October', 'November', 'December'
    ];
    document.getElementById('current-month').textContent = 
        `${monthNames[currentMonth]} ${currentYear}`;
}

function generateCalendar() {
    const calendarBody = document.getElementById('calendar-body');
    calendarBody.innerHTML = '';

    const firstDay = new Date(currentYear, currentMonth, 1).getDay();
    const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
    const today = new Date();

    let date = 1;
    
    // Generate 6 weeks (42 days) to ensure full calendar view
    for (let week = 0; week < 6; week++) {
        const row = document.createElement('tr');
        
        for (let day = 0; day < 7; day++) {
            const cell = document.createElement('td');
            cell.className = 'calendar-day';
            
            if (week === 0 && day < firstDay) {
                // Previous month's days
                const prevMonth = currentMonth === 0 ? 11 : currentMonth - 1;
                const prevYear = currentMonth === 0 ? currentYear - 1 : currentYear;
                const prevMonthDays = new Date(prevYear, prevMonth + 1, 0).getDate();
                const prevDate = prevMonthDays - firstDay + day + 1;
                
                cell.innerHTML = `<div class="text-muted">${prevDate}</div>`;
                cell.className += ' other-month';
            } else if (date > daysInMonth) {
                // Next month's days
                const nextDate = date - daysInMonth;
                cell.innerHTML = `<div class="text-muted">${nextDate}</div>`;
                cell.className += ' other-month';
                date++;
            } else {
                // Current month's days
                const currentDate = new Date(currentYear, currentMonth, date);
                const isToday = currentDate.toDateString() === today.toDateString();
                
                if (isToday) {
                    cell.className += ' today';
                }
                
                cell.innerHTML = `<div><strong>${date}</strong></div>`;
                
                // Add events for this date
                const dayEvents = getEventsForDate(currentDate);
                dayEvents.forEach(event => {
                    const eventElement = document.createElement('div');
                    eventElement.className = 'calendar-event';
                    eventElement.style.backgroundColor = categoryColors[event.category] || '#6c757d';
                    eventElement.textContent = event.title.length > 15 ? 
                        event.title.substring(0, 15) + '...' : event.title;
                    eventElement.onclick = () => showEventModal(event);
                    cell.appendChild(eventElement);
                });
                
                date++;
            }
            
            row.appendChild(cell);
        }
        
        calendarBody.appendChild(row);
        
        // Stop if we've shown all days
        if (date > daysInMonth) break;
    }
}

function getEventsForDate(date) {
    return events.filter(event => {
        const eventDate = new Date(event.start_date);
        return eventDate.toDateString() === date.toDateString();
    });
}

function showEventModal(event) {
    const modal = new bootstrap.Modal(document.getElementById('eventModal'));
    document.getElementById('eventModalTitle').textContent = event.title;
    
    const eventDate = new Date(event.start_date);
    const eventEndDate = new Date(event.end_date);
    
    document.getElementById('eventModalBody').innerHTML = `
        <p><strong>Description:</strong> ${event.description}</p>
        <p><strong>Venue:</strong> ${event.venue}</p>
        <p><strong>Date:</strong> ${eventDate.toLocaleDateString()}</p>
        <p><strong>Time:</strong> ${eventDate.toLocaleTimeString()} - ${eventEndDate.toLocaleTimeString()}</p>
        <p><strong>Category:</strong> <span class="badge" style="background-color: ${categoryColors[event.category] || '#6c757d'}">${event.category}</span></p>
        <p><strong>Attendees:</strong> ${event.current_attendees}${event.max_attendees ? '/' + event.max_attendees : ''}</p>
    `;
    
    document.getElementById('eventDetailsLink').href = `/student/event/${event.id}`;
    modal.show();
}

function previousMonth() {
    currentMonth--;
    if (currentMonth < 0) {
        currentMonth = 11;
        currentYear--;
    }
    updateCalendarHeader();
    generateCalendar();
}

function nextMonth() {
    currentMonth++;
    if (currentMonth > 11) {
        currentMonth = 0;
        currentYear++;
    }
    updateCalendarHeader();
    generateCalendar();
}

function today() {
    const now = new Date();
    currentMonth = now.getMonth();
    currentYear = now.getFullYear();
    updateCalendarHeader();
    generateCalendar();
}

// Initialize calendar when page loads
document.addEventListener('DOMContentLoaded', initCalendar);
</script>
{% endblock %}
